#!/bin/bash
# ============================================================================
# 脚本名称：build-sandbox-image-mac.sh
# 脚本用途：在macOS系统上构建沙箱Docker镜像
# 作者信息：purpose168@outlook.com
# ============================================================================
# 使用说明：
#   ./build-sandbox-image-mac.sh [架构类型]
#   
#   架构类型参数（可选）：
#     amd64  - 构建AMD64架构镜像（Intel芯片）
#     arm64  - 构建ARM64架构镜像（Apple Silicon芯片）
#     all    - 构建所有支持的架构镜像
#   
#   如果不指定架构参数，脚本会自动检测当前系统架构
# ============================================================================

# 设置严格的错误处理模式
# -e: 当命令返回非零状态码时立即退出脚本
# -u: 使用未定义的变量时视为错误
# -o pipefail: 管道中任一命令失败则整个管道返回失败状态
set -euo pipefail

# ============================================================================
# 路径配置部分
# ============================================================================

# 获取脚本所在目录的父目录（项目根目录）
# ${BASH_SOURCE[0]}: 当前脚本的完整路径
# dirname: 获取目录部分
# cd ... && pwd: 切换到目录并获取绝对路径，确保路径解析正确
ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)

# Docker构建脚本的完整路径
# 该脚本负责实际的Docker镜像构建工作
DOCKER_SCRIPT="${ROOT_DIR}/scripts/build-sandbox-image-docker.sh"

# ============================================================================
# 系统环境检查
# ============================================================================

# 检查是否在macOS系统上运行
# uname命令返回操作系统名称，Darwin是macOS的内核名称
# >&2 表示将错误消息输出到标准错误流（stderr）
if [ "$(uname)" != "Darwin" ]; then
  echo "错误：此脚本仅适用于macOS系统。" >&2
  exit 1
fi

# 检查Docker构建脚本是否存在且可执行
# -x: 检查文件是否存在且具有可执行权限
if [ ! -x "${DOCKER_SCRIPT}" ]; then
  echo "错误：缺少可执行脚本：${DOCKER_SCRIPT}" >&2
  exit 1
fi

# ============================================================================
# 架构参数处理
# ============================================================================

# 获取第一个命令行参数，如果未提供则为空字符串
# ${1:-} 语法：如果$1存在则使用其值，否则使用默认值（空字符串）
ARCH=${1:-}

# 如果未指定架构参数，则自动检测当前系统架构
if [ -z "${ARCH}" ]; then
  # uname -m 返回机器硬件名称
  # case语句根据不同的硬件架构设置ARCH变量
  case "$(uname -m)" in
    arm64|aarch64) 
      # ARM64架构（Apple Silicon芯片，如M1、M2、M3系列）
      ARCH=arm64 
      ;;
    x86_64) 
      # AMD64架构（Intel芯片）
      ARCH=amd64 
      ;;
    *)
      # 不支持的架构类型
      echo "错误：不支持的系统架构。" >&2
      exit 1
      ;;
  esac
fi

# ============================================================================
# 执行构建任务
# ============================================================================

# 根据指定的架构类型执行相应的构建操作
# ARCHS环境变量传递给Docker构建脚本，指定目标架构
case "${ARCH}" in
  amd64|arm64)
    # 构建单个指定架构的镜像
    # ARCHS变量设置为目标架构，然后执行Docker构建脚本
    ARCHS="${ARCH}" "${DOCKER_SCRIPT}"
    ;;
  all)
    # 构建所有支持的架构镜像
    # 先构建AMD64架构，再构建ARM64架构
    ARCHS=amd64 "${DOCKER_SCRIPT}"
    ARCHS=arm64 "${DOCKER_SCRIPT}"
    ;;
  *)
    # 无效的架构参数，显示使用帮助信息
    echo "错误：不支持的架构 '${ARCH}'。请使用：amd64 | arm64 | all" >&2
    exit 1
    ;;
esac
